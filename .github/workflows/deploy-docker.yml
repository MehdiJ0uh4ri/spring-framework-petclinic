name: Deploy with Terraform + Docker

on:
  workflow_run:
    workflows: ["Security & Docker Build"]
    branches: [ develop ]
    types: [completed]

env:
  TF_VERSION: 1.9.0

jobs:
  deploy:
    runs-on: ubuntu-22.04
    if: github.event.workflow_run.conclusion == 'success'
    
    permissions:
      contents: read
      packages: read  # â† NEED THIS to pull from GHCR
    
    steps:
      # ========== Checkout ==========
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
      
      # ========== Set Image Name ==========
      - name: Set Image Name
        run: echo "IMAGE_NAME=$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')/petclinic" >> $GITHUB_ENV

      # ========== Configure Docker ==========
      - name: Configure Docker for Terraform
        run: |
          set -e
          
          echo "Configuring Docker daemon..."
          sudo mkdir -p /etc/docker
          
          sudo tee /etc/docker/daemon.json > /dev/null <<'EOF'
          {
            "min-api-version": "1.32"
          }
          EOF
          
          sudo systemctl daemon-reload
          sudo systemctl restart docker
          sleep 2
          
          echo "âœ… Docker configured"

      # ========== CRITICAL: Login Docker to GHCR ==========
      - name: Login to GitHub Container Registry
        run: |
          echo "ðŸ” Authenticating Docker with GHCR..."
          
          # Use GitHub token to authenticate
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io \
            -u ${{ github.actor }} \
            --password-stdin
          
          echo "âœ… Docker authenticated with GHCR"

      # ========== Setup Terraform ==========
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # ========== Terraform Init ==========
      - name: Terraform Init
        working-directory: infrastructure
        run: terraform init
      
      # ========== Terraform Plan ==========
      - name: Terraform Plan
        working-directory: infrastructure
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
          TF_VAR_db_username: ${{ secrets.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASS }}
          TF_VAR_docker_image: "${{ secrets.APP_IMAGE }}:${{ github.event.workflow_run.head_sha }}"
        run: terraform plan -var-file="terraform.tfvars" -no-color

      # ========== Terraform Apply ==========
      - name: Terraform Apply
        working-directory: infrastructure
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
          TF_VAR_db_username: ${{ secrets.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASS }}
          TF_VAR_docker_image: "${{ secrets.APP_IMAGE }}:${{ github.event.workflow_run.head_sha }}"
        run: terraform apply -auto-approve -var-file="terraform.tfvars" -no-color

      # ========== Get Outputs ==========
      - name: Get Terraform Outputs
        working-directory: infrastructure
        if: success()
        run: |
          echo "=== Deployment Complete ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** $(terraform output -raw app_url 2>/dev/null || echo 'http://localhost:8080')" >> $GITHUB_STEP_SUMMARY
          echo "**Database:** $(terraform output -raw mysql_host 2>/dev/null || echo 'petclinic')" >> $GITHUB_STEP_SUMMARY
      
      # ========== Wait for Application ==========
      - name: Wait for Application
        run: |
          echo "â³ Waiting for application (max 120 seconds)..."
          for i in {1..120}; do
            if curl -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… Application is ready!"
              exit 0
            fi
            [ $((i % 20)) -eq 0 ] && echo "Attempt $i/120..."
            sleep 1
          done
          echo "âŒ Application timeout"
          exit 1
      
      # ========== Smoke Tests ==========
      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests..."
          if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
          echo "âœ… All tests passed"
      
      # ========== Show Logs ==========
      - name: Show Container Logs
        if: always()
        run: |
          echo "=== App Logs ===" 
          docker logs petclinic-app 2>&1 | tail -50 || true
          echo ""
          echo "=== MySQL Logs ===" 
          docker logs petclinic 2>&1 | tail -50 || true
      
      # ========== Save Info ==========
      - name: Save Connection Info
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: connection-info
          path: infrastructure/connection-info.json
          retention-days: 1
          overwrite: true
      
      # ========== Cleanup ==========
      - name: Terraform Destroy
        if: always()
        working-directory: infrastructure
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
          TF_VAR_db_username: ${{ secrets.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASS }}
          TF_VAR_docker_image: "${{ secrets.APP_IMAGE }}:${{ github.event.workflow_run.head_sha }}"
        run: terraform destroy -auto-approve -var-file="terraform.tfvars" -no-color
        continue-on-error: true

      # ========== Logout ==========
      - name: Logout from GHCR
        if: always()
        run: docker logout ghcr.io || true