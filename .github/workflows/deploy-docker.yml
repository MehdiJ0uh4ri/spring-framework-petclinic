name: Deploy with Terraform + Docker

on:
  # SCENARIO 1: Automatic Chaining
  # Triggers when the "Security & Docker Build" workflow completes
  workflow_run:
    workflows: ["Security & Docker Build"] # Must match the 'name:' in your build file exactly
    branches: [ develop ]
    types: [completed]

env:
  TF_VERSION: 1.9.0
   

jobs:
  deploy:
    runs-on: ubuntu-22.04
    # Only deploy if the "Security & Docker Build" workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    env:
      # Ensure Docker API used by Terraform's Docker provider is compatible
       
      TF_VERSION: 1.9.0
    
    steps:
      # ========== Checkout ==========
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          # CRITICAL: Deploy the specific commit that triggered the build
          ref: ${{ github.event.workflow_run.head_sha }}
      
      # FIX: Force lowercase image name (GHCR requirement)
      - name: Set Image Name
        run: echo "IMAGE_NAME=$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')/petclinic" >> $GITHUB_ENV

      # ========== Setup Docker ==========
      - name: Setup Docker 28.5.2 (Stable, Pre-v29)
        run: |
          set -e
          
          echo "Step 1: Remove Docker v29..."
          sudo apt-get remove -y docker-ce docker-ce-cli containerd.io || true
          
          echo "Step 2: Install Docker 28.5.2 (stable version)..."
          sudo apt-get update
          sudo apt-get install -y \
            docker-ce=5:28.5.2-1~ubuntu.22.04~jammy \
            docker-ce-cli=5:28.5.2-1~ubuntu.22.04~jammy \
            containerd.io=1.7.x* 2>/dev/null || \
          sudo apt-get install -y \
            docker-ce=5:28.5.2-1~ubuntu.22.04~jammy \
            docker-ce-cli=5:28.5.2-1~ubuntu.22.04~jammy \
            containerd.io
          
          echo "Step 3: Start Docker..."
          sudo systemctl start docker
          sleep 2
          
          echo "Step 4: Verify installation..."
          echo "Docker Version:"
          docker --version
          echo ""
          echo "Docker API Version:"
          docker version | grep "API version" || true
          echo ""
          
          echo "Step 5: Test Docker..."
          docker run --rm hello-world
          
          echo "✅ Docker setup complete"

      # ========== Setup Terraform ==========
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # ========== Terraform Init ==========
      - name: Terraform Init
        working-directory: infrastructure
        run: terraform init -upgrade
      
      # ========== Terraform Plan ==========
      - name: Terraform Plan
        working-directory: infrastructure
        run: terraform plan -var-file="terraform.tfvars"
        env:
          # FIX: Same here
           
          TF_VERSION: 1.9.0
          # ADD THESE LINES HERE TOO:
          TF_VAR_db_username: ${{ secrets.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASS }}
          TF_VAR_docker_image: "${{ secrets.APP_IMAGE }}:${{ github.event.workflow_run.head_sha }}"      
          DOCKER_HOST: unix:///var/run/docker.sock
          
          # ========== Terraform Apply ==========
      - name: Terraform Apply
        working-directory: infrastructure
        run: terraform apply -auto-approve -var-file="terraform.tfvars"
        env:
          # 1. Map GitHub Secrets to Terraform Variables
          TF_VAR_db_username: ${{ secrets.DB_USER }}
          TF_VAR_db_password: ${{ secrets.DB_PASS }}
          TF_VERSION: 1.9.0
          DOCKER_HOST: unix:///var/run/docker.sock  # ← Also add this to ensure Terraform can talk to Docker on the runner
          # 2. Construct the Image using your APP_IMAGE secret + the Dynamic Tag
          # Assuming secrets.APP_IMAGE is "ghcr.io/mehdij0uh4ri/petclinic"
          TF_VAR_docker_image: "${{ secrets.APP_IMAGE }}:${{ github.event.workflow_run.head_sha }}"
           
          

      # ========== Get Outputs ==========
      - name: Get Terraform Outputs
        working-directory: infrastructure
        run: |
          echo "=== Deployment Complete ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "App URL: $(terraform output -raw app_url)" >> $GITHUB_STEP_SUMMARY
          echo "MySQL Host: $(terraform output -raw mysql_host)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Connection Info saved to: infrastructure/connection-info.json" >> $GITHUB_STEP_SUMMARY
      
      # ========== Wait for Application ==========
      - name: Wait for Application to be Ready
        run: |
          echo "Waiting for application to be ready..."
          for i in {1..60}; do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "✅ Application is ready!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "❌ Application failed to start"
              exit 1
            fi
            echo "Attempt $i/60..."
            sleep 2
          done
      

          
      # ========== Smoke Tests ==========
      - name: Run Smoke Tests
        run: |
          echo "Testing application..."
          curl -v http://localhost:8080/ || exit 1
          curl -v http://localhost:8080/actuator/health || exit 1
          echo "✅ Smoke tests passed"
      
      # ========== Show Container Logs ==========
      - name: Show Container Logs
        if: always()
        run: |
          echo "=== Application Container Logs ===" 
          docker logs petclinic-app || true
          echo ""
          echo "=== MySQL Container Logs ===" 
          docker logs petclinic || true
      
      # ========== List Running Containers ==========
      - name: List Containers
        run: docker ps -a
      
      - name: Save Connection Info
        if: success()
        uses: actions/upload-artifact@v4  # <--- UPDATED
        with:
          name: connection-info
          path: infrastructure/connection-info.json
          retention-days: 1
          overwrite: true  # v4 feature: prevents errors if the artifact already exists
      
      # ========== Cleanup (Optional) ==========
      - name: Terraform Destroy
        if: always()
        env:
             # ← Must have this too
          DOCKER_HOST: unix:///var/run/docker.sock
        working-directory: infrastructure
        run: terraform destroy -auto-approve -var-file="terraform.tfvars"
        continue-on-error: true