# ============================================================================
# PHASE 2: SECURITY SCANNING + DOCKER BUILD + PUSH WORKFLOW
# ============================================================================
name: Security & Docker Build

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

env:
  JAVA_VERSION: '17'
  REGISTRY: ghcr.io

jobs:
  security-and-build:
    runs-on: ubuntu-22.04
    name: Security Scan & Docker Build
    permissions:
      contents: read
      packages: write      # ‚Üê CRITICAL: Allows pushing to GHCR
      security-events: write

    steps:
      
      # ========== Set lowercase image name ==========
      - name: Set lowercase image name
        run: |
          REPO_LC="$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')"
          echo "IMAGE_NAME=${{ env.REGISTRY }}/${REPO_LC}/petclinic" >> "$GITHUB_ENV"
          echo "IMAGE_TAG_SHA=${GITHUB_SHA}" >> "$GITHUB_ENV"
          echo "IMAGE_TAG_LATEST=latest" >> "$GITHUB_ENV"
          
          echo "Full image name: ${{ env.REGISTRY }}/${REPO_LC}/petclinic:${GITHUB_SHA}"

      # ========== Checkout ==========
      - name: Checkout code
        uses: actions/checkout@v4

      # ========== Setup Java ==========
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      # ========== Build Application ==========
      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      # ========== Prepare reports ==========
      - name: Prepare reports directory
        run: mkdir -p reports

      # ========== OWASP Dependency Check ==========
      - name: OWASP Dependency-Check
        continue-on-error: true
        uses: dependency-check/Dependency-Check_Action@main
        env:
          JAVA_HOME: /opt/jdk
        with:
          project: 'PetClinic'
          path: '.'
          format: 'SARIF'
          out: 'reports'
          args: >-
            --enableExperimental
            --failOnCVSS 7
            --disableCentral

      # ========== Upload Dependency Results ==========
      - name: Upload dependency scan results
        if: always() && hashFiles('reports/dependency-check-report.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'reports/dependency-check-report.sarif'
          category: 'dependency-scan'

      # ========== Build Docker Image ==========
      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          echo "Image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          docker build \
            -t ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.IMAGE_NAME }}:latest \
            .
          
          echo "‚úÖ Docker image built successfully"
          docker images | grep petclinic

      # ========== Scan Image with Trivy ==========
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      # ========== Upload Container Scan ==========
      - name: Upload container scan results
        if: always() && hashFiles('trivy-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'container-scan'

      # ========== NEW: Login to GitHub Container Registry ==========
      # CRITICAL: This must happen BEFORE pushing to GHCR
      - name: Login to GitHub Container Registry
        run: |
          echo "üîê Authenticating with GitHub Container Registry..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} \
            -u ${{ github.actor }} \
            --password-stdin
          echo "‚úÖ Authentication successful"

      # ========== NEW: Push Image to GHCR ==========
      # This is what was missing! The image needs to be in GHCR
      # before the deploy workflow tries to pull it
      - name: Push Docker image to GHCR
        run: |
          echo "üì§ Pushing Docker image to GHCR..."
          
          # Push with commit SHA tag
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}
          echo "‚úÖ Pushed: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # Push with latest tag
          docker push ${{ env.IMAGE_NAME }}:latest
          echo "‚úÖ Pushed: ${{ env.IMAGE_NAME }}:latest"
          
          echo ""
          echo "Image available at:"
          echo "  ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "  ${{ env.IMAGE_NAME }}:latest"

      # ========== Logout from GHCR ==========
      - name: Logout from GHCR
        if: always()
        run: docker logout ${{ env.REGISTRY }} || true

      # ========== Security Summary ==========
      - name: Security Scan Summary
        if: always()
        run: |
          echo "üìã Security & Build Complete"
          echo "=============================="
          echo "‚úÖ Build Status: Passed"
          echo "‚úÖ Dependency Scan: Completed"
          echo "‚úÖ Container Scan: Completed"
          echo "‚úÖ Image Pushed: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo ""
          echo "Next: Deploy workflow will pull and deploy this image"